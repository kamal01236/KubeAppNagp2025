apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-api
  labels:
    app: service-api
spec:
  replicas: 4
  selector:
    matchLabels:
      app: service-api
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: service-api
    spec:
      containers:
      - name: service-api
        image: kamal01236/service-api:latest
        ports:
        - containerPort: 80
        env:
        # These environment variables are sourced from ConfigMap and Secret
        - name: SQL_SERVER
          valueFrom:
            configMapKeyRef:
              name: sqlserver-config
              key: SQL_SERVER
        - name: SQL_DB
          valueFrom:
            configMapKeyRef:
              name: sqlserver-config
              key: SQL_DB
        - name: SQL_USER
          valueFrom:
            configMapKeyRef:
              name: sqlserver-config
              key: SQL_USER
        - name: SQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: sqlserver-secret
              key: SA_PASSWORD
        # Use 'command' and 'args' to construct the ConnectionStrings__DefaultConnection
        # This allows shell-level variable expansion (e.g., ${SQL_PASSWORD})
        command: ["/bin/sh", "-c"]
        args:
          - export ConnectionStrings__DefaultConnection="Server=${SQL_SERVER};Database=${SQL_DB};User Id=${SQL_USER};Password=${SQL_PASSWORD};TrustServerCertificate=True;";
            exec dotnet ServiceApi.dll # IMPORTANT: Replace 'ServiceApi.dll' with your actual application's entry point (e.g., your-app-name.dll)
